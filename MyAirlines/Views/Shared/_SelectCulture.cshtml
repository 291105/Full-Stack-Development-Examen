@using Microsoft.AspNetCore.Localization
@using Microsoft.AspNetCore.Mvc.Rendering
@using Microsoft.Extensions.Options

@inject IOptions<RequestLocalizationOptions> locOptions

@{
    // Get the current culture set by the localization middleware.
    var currentRequestCulture = Context.Features.Get<IRequestCultureFeature>();
    // List of supported cultures for language selection.
    var cultureItems = locOptions.Value.SupportedUICultures
        .Select(c => new SelectListItem { Value = c.Name, Text = c.DisplayName })
        .ToList();
    // Return URL for after language change.
    var responseUrl = string.IsNullOrEmpty(Context.Request.Path) ? "~/" : $"~{Context.Request.Path.Value}";

    // Map culture codes (first two letters) to country codes used by FlagCDN.
    var flagMap = new Dictionary<string, string> {
        { "nl", "nl" },
        { "fr", "fr" },
        { "en", "gb" },
        { "es", "es" }
    };

    // Determine the current culture.
    var currentCulture = currentRequestCulture.RequestCulture.UICulture.Name.Split('-')[0].ToLower();
    var currentItem = cultureItems.FirstOrDefault(i => i.Value.StartsWith(currentCulture))
                      ?? new SelectListItem { Value = currentCulture, Text = currentCulture };
    var currentCountryCode = flagMap.ContainsKey(currentCulture) ? flagMap[currentCulture] : currentCulture;
}

    <!-- Custom Dropdown with Flag Images -->
    <div class="dropdown">
        <div class="dropdown-btn" id="selected">
            <img class="flag" src="https://flagcdn.com/w20/@(currentCountryCode).png" alt="@currentItem.Text Flag">
            @currentItem.Text
        </div>
        <div class="dropdown-content" id="langOptions">
            @foreach (var item in cultureItems)
            {
                var shortCode = item.Value.Split('-')[0].ToLower();
                var countryCode = flagMap.ContainsKey(shortCode) ? flagMap[shortCode] : shortCode;
            <div data-lang="@item.Value" data-label="@item.Text" class="dropdown-item">
                    <img class="flag" src="https://flagcdn.com/w20/@(countryCode).png" alt="@item.Text Flag">
                    @item.Text
                </div>
            }
        </div>
    </div>

    <!-- Hidden form auto-submitted upon selection -->
    <form id="selectLanguage" asp-controller="Home" asp-action="SetAppLanguage" asp-route-returnUrl="@responseUrl" method="post">
        <input type="hidden" name="lang" id="langInput" value="@currentRequestCulture.RequestCulture.UICulture.Name" />
    </form>

    <script>
    document.querySelectorAll('#langOptions div').forEach(el => {
        el.addEventListener('click', () => {
            // Get selected data.
            const lang = el.getAttribute('data-lang');
            const label = el.getAttribute('data-label');
            const imgSrc = el.querySelector('img').src;

            // Get the button and remove its current children.
            const selectedBtn = document.getElementById('selected');
            while (selectedBtn.firstChild) {
                selectedBtn.removeChild(selectedBtn.firstChild);
            }

            // Create and append a new image element.
            const flagImg = document.createElement('img');
            flagImg.className = 'flag';
            flagImg.src = imgSrc;
            flagImg.alt = 'Flag';
            selectedBtn.appendChild(flagImg);

            // Append the label as a text node.
            selectedBtn.appendChild(document.createTextNode(' ' + label));

            // Set the hidden input value and submit the form.
            document.getElementById('langInput').value = lang;
            document.getElementById('selectLanguage').submit();
        });
    });

    </script>
